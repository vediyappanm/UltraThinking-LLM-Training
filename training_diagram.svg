<svg viewBox="0 0 1600 1800" xmlns="http://www.w3.org/2000/svg">
    <!-- Title -->
    <text x="800" y="35" text-anchor="middle" font-size="26" font-weight="bold" fill="#1a237e">ULTRATHINK TRAINING PIPELINE</text>
    <text x="800" y="60" text-anchor="middle" font-size="14" fill="#555">Complete End-to-End Model Training Architecture</text>
    
    <!-- Defs for arrows and gradients -->
    <defs>
        <marker id="arrowMain" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#1a237e"/>
        </marker>
        <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#2d7d2d"/>
        </marker>
        <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#c41e3a"/>
        </marker>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#e3f2fd;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#bbdefb;stop-opacity:1" />
        </linearGradient>
    </defs>
    
    <!-- Background -->
    <rect x="20" y="80" width="1560" height="1700" fill="#fafafa" stroke="#1a237e" stroke-width="2" rx="15"/>
    
    <!-- ========== PHASE 1: INITIALIZATION ========== -->
    <rect x="50" y="100" width="1500" height="200" fill="url(#grad1)" stroke="#2c5aa0" stroke-width="3" rx="10"/>
    <text x="800" y="130" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a237e">PHASE 1: INITIALIZATION</text>
    
    <!-- Config Loading -->
    <rect x="100" y="160" width="200" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="200" y="185" text-anchor="middle" font-size="14" font-weight="bold">‚öôÔ∏è Load Config</text>
    <text x="200" y="205" text-anchor="middle" font-size="10">‚Ä¢ Model architecture</text>
    <text x="200" y="220" text-anchor="middle" font-size="10">‚Ä¢ Training params</text>
    <text x="200" y="235" text-anchor="middle" font-size="10">‚Ä¢ Optimizer settings</text>
    <text x="200" y="250" text-anchor="middle" font-size="10">‚Ä¢ Hardware config</text>
    
    <!-- Dataset Loading -->
    <rect x="350" y="160" width="220" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="460" y="185" text-anchor="middle" font-size="14" font-weight="bold">üìÅ Load Datasets</text>
    <text x="460" y="205" text-anchor="middle" font-size="10">WikiText / Pile / C4</text>
    <text x="460" y="220" text-anchor="middle" font-size="10">Tokenizer: GPT-2 BPE</text>
    <text x="460" y="235" text-anchor="middle" font-size="10">Vocab size: 50,257</text>
    <text x="460" y="250" text-anchor="middle" font-size="10">Seq length: 2048</text>
    
    <!-- Model Creation -->
    <rect x="620" y="160" width="240" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="740" y="185" text-anchor="middle" font-size="14" font-weight="bold">üß† Create Model</text>
    <text x="740" y="205" text-anchor="middle" font-size="10">Transformer + MoE¬≥</text>
    <text x="740" y="220" text-anchor="middle" font-size="10">760M parameters</text>
    <text x="740" y="235" text-anchor="middle" font-size="10">24 layers √ó 2048 dim</text>
    <text x="740" y="250" text-anchor="middle" font-size="10">120 experts (4-level)</text>
    
    <!-- Optimizer Setup -->
    <rect x="910" y="160" width="220" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="1020" y="185" text-anchor="middle" font-size="14" font-weight="bold">üéØ Setup Optimizer</text>
    <text x="1020" y="205" text-anchor="middle" font-size="10">AdamW</text>
    <text x="1020" y="220" text-anchor="middle" font-size="10">LR: 3e-4</text>
    <text x="1020" y="235" text-anchor="middle" font-size="10">Weight decay: 0.1</text>
    <text x="1020" y="250" text-anchor="middle" font-size="10">Warmup: 2000 steps</text>
    
    <!-- Distributed Setup -->
    <rect x="1180" y="160" width="270" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="1315" y="185" text-anchor="middle" font-size="14" font-weight="bold">üåê Distributed Setup</text>
    <text x="1315" y="205" text-anchor="middle" font-size="10">DeepSpeed ZeRO-3</text>
    <text x="1315" y="220" text-anchor="middle" font-size="10">4D Parallelism</text>
    <text x="1315" y="235" text-anchor="middle" font-size="10">GPU Cluster: 8-256</text>
    <text x="1315" y="250" text-anchor="middle" font-size="10">Mixed Precision (BF16)</text>
    
    <!-- Arrow down to Phase 2 -->
    <line x1="800" y1="300" x2="800" y2="340" stroke="#1a237e" stroke-width="4" marker-end="url(#arrowMain)"/>
    
    <!-- ========== PHASE 2: TRAINING LOOP ========== -->
    <rect x="50" y="340" width="1500" height="680" fill="#e8f5e9" stroke="#2d7d2d" stroke-width="3" rx="10"/>
    <text x="800" y="370" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a237e">PHASE 2: TRAINING LOOP (150K steps)</text>
    
    <!-- Data Loading -->
    <rect x="100" y="400" width="220" height="90" fill="#e8f4f8" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="210" y="425" text-anchor="middle" font-size="14" font-weight="bold">üì¶ Get Batch</text>
    <text x="210" y="445" text-anchor="middle" font-size="10">Batch size: 32</text>
    <text x="210" y="460" text-anchor="middle" font-size="10">Seq length: 2048</text>
    <text x="210" y="475" text-anchor="middle" font-size="10">4 workers parallel load</text>
    
    <!-- Arrow to Forward Pass -->
    <line x1="210" y1="490" x2="210" y2="540" stroke="#2d7d2d" stroke-width="3" marker-end="url(#arrowGreen)"/>
    
    <!-- Forward Pass -->
    <rect x="100" y="540" width="220" height="120" fill="#fff4e6" stroke="#d68910" stroke-width="2" rx="5"/>
    <text x="210" y="565" text-anchor="middle" font-size="14" font-weight="bold">‚û°Ô∏è Forward Pass</text>
    <text x="210" y="585" text-anchor="middle" font-size="10">Embedding layer</text>
    <text x="210" y="600" text-anchor="middle" font-size="10">24 √ó Transformer blocks</text>
    <text x="210" y="615" text-anchor="middle" font-size="10">‚Ä¢ GQA Attention</text>
    <text x="210" y="630" text-anchor="middle" font-size="10">‚Ä¢ MoE¬≥ FFN</text>
    <text x="210" y="645" text-anchor="middle" font-size="10">LM Head ‚Üí Logits</text>
    
    <!-- Model Architecture Detail (Side) -->
    <rect x="360" y="540" width="260" height="280" fill="#f0f0f0" stroke="#7d3c98" stroke-width="2" rx="5" stroke-dasharray="5,5"/>
    <text x="490" y="565" text-anchor="middle" font-size="13" font-weight="bold">üèóÔ∏è Model Architecture</text>
    
    <!-- Transformer Block -->
    <rect x="380" y="580" width="220" height="110" fill="#fff" stroke="#666" stroke-width="1" rx="3"/>
    <text x="490" y="600" text-anchor="middle" font-size="11" font-weight="bold">Transformer Block</text>
    <text x="490" y="620" text-anchor="middle" font-size="9">RMSNorm ‚Üí Attention</text>
    <text x="490" y="635" text-anchor="middle" font-size="9">+ Residual</text>
    <text x="490" y="650" text-anchor="middle" font-size="9">RMSNorm ‚Üí FFN/MoE</text>
    <text x="490" y="665" text-anchor="middle" font-size="9">+ Residual</text>
    <text x="490" y="680" text-anchor="middle" font-size="8" fill="#666">√ó 24 layers</text>
    
    <!-- MoE Detail -->
    <rect x="380" y="700" width="220" height="110" fill="#fff" stroke="#666" stroke-width="1" rx="3"/>
    <text x="490" y="720" text-anchor="middle" font-size="11" font-weight="bold">MoE¬≥ System</text>
    <text x="490" y="740" text-anchor="middle" font-size="9">Knowledge: 64 experts</text>
    <text x="490" y="755" text-anchor="middle" font-size="9">Skill: 32 experts</text>
    <text x="490" y="770" text-anchor="middle" font-size="9">Meta: 16 experts</text>
    <text x="490" y="785" text-anchor="middle" font-size="9">Safety: 8 experts</text>
    <text x="490" y="800" text-anchor="middle" font-size="8" fill="#666">Top-2 routing per token</text>
    
    <!-- Arrow to Loss -->
    <line x1="210" y1="660" x2="210" y2="710" stroke="#2d7d2d" stroke-width="3" marker-end="url(#arrowGreen)"/>
    
    <!-- Loss Computation -->
    <rect x="100" y="710" width="220" height="110" fill="#fef0f0" stroke="#c41e3a" stroke-width="2" rx="5"/>
    <text x="210" y="735" text-anchor="middle" font-size="14" font-weight="bold">üìâ Compute Loss</text>
    <text x="210" y="755" text-anchor="middle" font-size="10">Cross-Entropy Loss</text>
    <text x="210" y="770" text-anchor="middle" font-size="10">+ Auxiliary losses:</text>
    <text x="210" y="785" text-anchor="middle" font-size="10">‚Ä¢ Load balancing</text>
    <text x="210" y="800" text-anchor="middle" font-size="10">‚Ä¢ Constitutional AI</text>
    
    <!-- Arrow to Backward -->
    <line x1="210" y1="820" x2="210" y2="870" stroke="#2d7d2d" stroke-width="3" marker-end="url(#arrowGreen)"/>
    
    <!-- Backward Pass -->
    <rect x="100" y="870" width="220" height="120" fill="#e8f4f8" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="210" y="895" text-anchor="middle" font-size="14" font-weight="bold">‚¨ÖÔ∏è Backward Pass</text>
    <text x="210" y="915" text-anchor="middle" font-size="10">Compute gradients</text>
    <text x="210" y="930" text-anchor="middle" font-size="10">Flash Attention</text>
    <text x="210" y="945" text-anchor="middle" font-size="10">Gradient checkpointing</text>
    <text x="210" y="960" text-anchor="middle" font-size="10">Mixed precision (BF16)</text>
    <text x="210" y="975" text-anchor="middle" font-size="9" fill="#666">Memory efficient backprop</text>
    
    <!-- Optimization Steps (Right side) -->
    <!-- Gradient Clipping -->
    <rect x="660" y="870" width="200" height="100" fill="#fff4e6" stroke="#d68910" stroke-width="2" rx="5"/>
    <text x="760" y="895" text-anchor="middle" font-size="14" font-weight="bold">‚úÇÔ∏è Gradient Clip</text>
    <text x="760" y="915" text-anchor="middle" font-size="10">Max norm: 1.0</text>
    <text x="760" y="930" text-anchor="middle" font-size="10">Prevent explosion</text>
    <text x="760" y="945" text-anchor="middle" font-size="10">Stabilize training</text>
    <text x="760" y="960" text-anchor="middle" font-size="9" fill="#666">Global norm clipping</text>
    
    <!-- Optimizer Step -->
    <rect x="900" y="870" width="200" height="100" fill="#e8f5e9" stroke="#2d7d2d" stroke-width="2" rx="5"/>
    <text x="1000" y="895" text-anchor="middle" font-size="14" font-weight="bold">üîÑ Optimizer Step</text>
    <text x="1000" y="915" text-anchor="middle" font-size="10">AdamW update</text>
    <text x="1000" y="930" text-anchor="middle" font-size="10">LR schedule: Cosine</text>
    <text x="1000" y="945" text-anchor="middle" font-size="10">Update 760M params</text>
    <text x="1000" y="960" text-anchor="middle" font-size="9" fill="#666">Œ∏ ‚Üê Œ∏ - Œ∑‚àáL</text>
    
    <!-- Learning Rate -->
    <rect x="1140" y="870" width="200" height="100" fill="#f5e6ff" stroke="#7d3c98" stroke-width="2" rx="5"/>
    <text x="1240" y="895" text-anchor="middle" font-size="14" font-weight="bold">üìà LR Schedule</text>
    <text x="1240" y="915" text-anchor="middle" font-size="10">Warmup: 2K steps</text>
    <text x="1240" y="930" text-anchor="middle" font-size="10">Peak LR: 3e-4</text>
    <text x="1240" y="945" text-anchor="middle" font-size="10">Cosine decay</text>
    <text x="1240" y="960" text-anchor="middle" font-size="9" fill="#666">Min LR: 3e-5</text>
    
    <!-- Arrows connecting optimization steps -->
    <line x1="320" y1="920" x2="660" y2="920" stroke="#2d7d2d" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <line x1="860" y1="920" x2="900" y2="920" stroke="#2d7d2d" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <line x1="1100" y1="920" x2="1140" y2="920" stroke="#2d7d2d" stroke-width="2" marker-end="url(#arrowGreen)"/>
    
    <!-- Arrow down to Phase 3 -->
    <line x1="800" y1="1020" x2="800" y2="1070" stroke="#1a237e" stroke-width="4" marker-end="url(#arrowMain)"/>
    
    <!-- ========== PHASE 3: MONITORING & CHECKPOINTING ========== -->
    <rect x="50" y="1070" width="1500" height="250" fill="#fff4e6" stroke="#d68910" stroke-width="3" rx="10"/>
    <text x="800" y="1100" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a237e">PHASE 3: MONITORING & CHECKPOINTING</text>
    
    <!-- Metrics Logging -->
    <rect x="100" y="1130" width="280" height="160" fill="#fff" stroke="#7d3c98" stroke-width="2" rx="5"/>
    <text x="240" y="1155" text-anchor="middle" font-size="14" font-weight="bold">üìä Log Metrics</text>
    <text x="240" y="1175" text-anchor="middle" font-size="10">W&B / TensorBoard</text>
    <text x="240" y="1195" text-anchor="middle" font-size="10">‚Ä¢ Loss: 2.4 ‚Üí 1.8</text>
    <text x="240" y="1210" text-anchor="middle" font-size="10">‚Ä¢ Perplexity: 11.2 ‚Üí 6.1</text>
    <text x="240" y="1225" text-anchor="middle" font-size="10">‚Ä¢ Expert entropy: 0.92</text>
    <text x="240" y="1240" text-anchor="middle" font-size="10">‚Ä¢ Gradient norm: 0.87</text>
    <text x="240" y="1255" text-anchor="middle" font-size="10">‚Ä¢ Learning rate: 2.8e-4</text>
    <text x="240" y="1270" text-anchor="middle" font-size="10">‚Ä¢ GPU util: 94%</text>
    
    <!-- System Monitoring -->
    <rect x="420" y="1130" width="280" height="160" fill="#fff" stroke="#c41e3a" stroke-width="2" rx="5"/>
    <text x="560" y="1155" text-anchor="middle" font-size="14" font-weight="bold">üñ•Ô∏è System Monitor</text>
    <text x="560" y="1175" text-anchor="middle" font-size="10">Hardware metrics</text>
    <text x="560" y="1195" text-anchor="middle" font-size="10">‚Ä¢ GPU memory: 76GB/80GB</text>
    <text x="560" y="1210" text-anchor="middle" font-size="10">‚Ä¢ Throughput: 12.4K tok/s</text>
    <text x="560" y="1225" text-anchor="middle" font-size="10">‚Ä¢ Temperature: 78¬∞C</text>
    <text x="560" y="1240" text-anchor="middle" font-size="10">‚Ä¢ Power: 320W/400W</text>
    <text x="560" y="1255" text-anchor="middle" font-size="10">‚Ä¢ Network: 42GB/s</text>
    <text x="560" y="1270" text-anchor="middle" font-size="10">‚Ä¢ Steps/sec: 1.2</text>
    
    <!-- Checkpointing -->
    <rect x="740" y="1130" width="280" height="160" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="880" y="1155" text-anchor="middle" font-size="14" font-weight="bold">üíæ Save Checkpoint</text>
    <text x="880" y="1175" text-anchor="middle" font-size="10">Every 5000 steps</text>
    <text x="880" y="1195" text-anchor="middle" font-size="10">checkpoint.pt contains:</text>
    <text x="880" y="1210" text-anchor="middle" font-size="10">‚Ä¢ model_state_dict</text>
    <text x="880" y="1225" text-anchor="middle" font-size="10">‚Ä¢ optimizer_state_dict</text>
    <text x="880" y="1240" text-anchor="middle" font-size="10">‚Ä¢ scheduler_state</text>
    <text x="880" y="1255" text-anchor="middle" font-size="10">‚Ä¢ step, epoch, metrics</text>
    <text x="880" y="1270" text-anchor="middle" font-size="10">‚Ä¢ RNG states</text>
    
    <!-- Validation -->
    <rect x="1060" y="1130" width="280" height="160" fill="#fff" stroke="#2d7d2d" stroke-width="2" rx="5"/>
    <text x="1200" y="1155" text-anchor="middle" font-size="14" font-weight="bold">‚úÖ Validation</text>
    <text x="1200" y="1175" text-anchor="middle" font-size="10">Every 1000 steps</text>
    <text x="1200" y="1195" text-anchor="middle" font-size="10">Val loss: 2.12</text>
    <text x="1200" y="1210" text-anchor="middle" font-size="10">Val perplexity: 8.3</text>
    <text x="1200" y="1225" text-anchor="middle" font-size="10">Early stopping check</text>
    <text x="1200" y="1240" text-anchor="middle" font-size="10">Best model tracking</text>
    <text x="1200" y="1255" text-anchor="middle" font-size="10">Benchmark evals</text>
    <text x="1200" y="1270" text-anchor="middle" font-size="9" fill="#666">MMLU: 68.4% | HumanEval: 52.1%</text>
    
    <!-- Loop back arrow -->
    <path d="M 1340 1200 L 1480 1200 L 1480 445 L 320 445" stroke="#2d7d2d" stroke-width="3" fill="none" marker-end="url(#arrowGreen)" stroke-dasharray="10,5"/>
    <text x="1450" y="800" text-anchor="middle" font-size="12" font-weight="bold" fill="#2d7d2d" transform="rotate(90 1450 800)">REPEAT 150K STEPS</text>
    
    <!-- Arrow down to Phase 4 -->
    <line x1="800" y1="1320" x2="800" y2="1370" stroke="#1a237e" stroke-width="4" marker-end="url(#arrowMain)"/>
    
    <!-- ========== PHASE 4: DISTRIBUTED TRAINING ========== -->
    <rect x="50" y="1370" width="1500" height="200" fill="#f0f8f0" stroke="#2d7d2d" stroke-width="3" rx="10"/>
    <text x="800" y="1400" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a237e">PHASE 4: 4D PARALLELISM STRATEGY</text>
    
    <!-- Data Parallelism -->
    <rect x="100" y="1430" width="300" height="110" fill="#fff" stroke="#2c5aa0" stroke-width="2" rx="5"/>
    <text x="250" y="1455" text-anchor="middle" font-size="14" font-weight="bold">1Ô∏è‚É£ Data Parallel (DP)</text>
    <text x="250" y="1475" text-anchor="middle" font-size="10">Same model, different data</text>
    <text x="250" y="1490" text-anchor="middle" font-size="10">GPU0: Batch 0-31</text>
    <text x="250" y="1505" text-anchor="middle" font-size="10">GPU1: Batch 32-63</text>
    <text x="250" y="1520" text-anchor="middle" font-size="10">Gradient sync via AllReduce</text>
    
    <!-- Tensor Parallelism -->
    <rect x="440" y="1430" width="300" height="110" fill="#fff" stroke="#d68910" stroke-width="2" rx="5"/>
    <text x="590" y="1455" text-anchor="middle" font-size="14" font-weight="bold">2Ô∏è‚É£ Tensor Parallel (TP)</text>
    <text x="590" y="1475" text-anchor="middle" font-size="10">Split layers horizontally</text>
    <text x="590" y="1490" text-anchor="middle" font-size="10">GPU0: Attention heads 0-15</text>
    <text x="590" y="1505" text-anchor="middle" font-size="10">GPU1: Attention heads 16-31</text>
    <text x="590" y="1520" text-anchor="middle" font-size="10">Megatron-LM style sharding</text>
    
    <!-- Pipeline Parallelism -->
    <rect x="780" y="1430" width="300" height="110" fill="#fff" stroke="#7d3c98" stroke-width="2" rx="5"/>
    <text x="930" y="1455" text-anchor="middle" font-size="14" font-weight="bold">3Ô∏è‚É£ Pipeline Parallel (PP)</text>
    <text x="930" y="1475" text-anchor="middle" font-size="10">Split layers vertically</text>
    <text x="930" y="1490" text-anchor="middle" font-size="10">GPU0: Layers 0-7</text>
    <text x="930" y="1505" text-anchor="middle" font-size="10">GPU1: Layers 8-15</text>
    <text x="930" y="1520" text-anchor="middle" font-size="10">Micro-batching for efficiency</text>
    
    <!-- Expert Parallelism -->
    <rect x="1120" y="1430" width="300" height="110" fill="#fff" stroke="#c41e3a" stroke-width="2" rx="5"/>
    <text x="1270" y="1455" text-anchor="middle" font-size="14" font-weight="bold">4Ô∏è‚É£ Expert Parallel (EP)</text>
    <text x="1270" y="1475" text-anchor="middle" font-size="10">Split experts across GPUs</text>
    <text x="1270" y="1490" text-anchor="middle" font-size="10">GPU0: Experts 0-29</text>
    <text x="1270" y="1505" text-anchor="middle" font-size="10">GPU1: Experts 30-59</text>
    <text x="1270" y="1520" text-anchor="middle" font-size="10">All-to-All communication</text>
    
    <!-- Arrow down to Phase 5 -->
    <line x1="800" y1="1570" x2="800" y2="1620" stroke="#1a237e" stroke-width="4" marker-end="url(#arrowMain)"/>
    
    <!-- ========== PHASE 5: COMPLETION ========== -->
    <rect x="350" y="1620" width="900" height="130" fill="url(#grad1)" stroke="#2c5aa0" stroke-width="3" rx="10"/>
    <text x="800" y="1655" text-anchor="middle" font-size="20" font-weight="bold" fill="#1a237e">üéâ TRAINING COMPLETE</text>
    <text x="800" y="1685" text-anchor="middle" font-size="14">Final Model: checkpoint_150000.pt</text>
    <text x="800" y="1705" text-anchor="middle" font-size="12">Loss: 2.38 | Perplexity: 10.8 | MMLU: 68.4% | Safety: 96.2%</text>
    <text x="800" y="1730" text-anchor="middle" font-size="14" font-weight="bold" fill="#2d7d2d">‚úÖ Ready for Deployment</text>
    
    <!-- Performance Summary Box -->
    <rect x="50" y="1760" width="1500" height="30" fill="#f9f9f9" stroke="#1a237e" stroke-width="2" rx="5"/>
    <text x="800" y="1780" text-anchor="middle" font-size="11"><tspan font-weight="bold">Training Stats:</tspan> 16 days on 256 GPUs | 150K steps | 12.4K tok/s | 2.4 final loss | 80% cost reduction via MoE</text>
</svg>
